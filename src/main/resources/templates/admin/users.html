<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::content}, ~{::scripts})}">
<head>
    <title>User Management</title>
</head>
<body>
    <div th:fragment="content">
        <!-- Page Header -->
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-4" data-aos="fade-up">
            <div>
                <h1 class="h3 mb-1 fw-bold">User Management</h1>
                <p class="text-muted mb-0">Manage system users, roles, and permissions</p>
            </div>
            <div class="btn-toolbar">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                    <i class="bi bi-person-plus me-1"></i> Create User
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="filterForm" method="get">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="searchTerm" class="form-label">Search</label>
                            <input type="text" class="form-control" id="searchTerm" name="searchTerm" 
                                   th:value="${param.searchTerm}" placeholder="Search by name or username">
                        </div>
                        <div class="col-md-3">
                            <label for="userRole" class="form-label">Role</label>
                            <select class="form-select" id="userRole" name="userRole">
                                <option value="">All Roles</option>
                                <option th:each="role : ${T(org.example.administrator.enums.UserRole).values()}" 
                                        th:value="${role}" 
                                        th:text="${role.displayName}"
                                        th:selected="${param.userRole == role}"></option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="userStatus" class="form-label">Status</label>
                            <select class="form-select" id="userStatus" name="userStatus">
                                <option value="">All Statuses</option>
                                <option th:each="status : ${T(org.example.administrator.enums.UserStatus).values()}" 
                                        th:value="${status}" 
                                        th:text="${status.displayName}"
                                        th:selected="${param.userStatus == status}"></option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-outline-primary">
                                    <i class="bi bi-search"></i> Filter
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Users Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="user : ${users.content}">
                                <td th:text="${user.id}">1</td>
                                <td th:text="${user.username}">username</td>
                                <td th:text="${user.fullName}">Full Name</td>
                                <td th:text="${user.email}">email@example.com</td>
                                <td>
                                    <span class="badge bg-primary" th:text="${user.userRole.displayName}">Role</span>
                                </td>
                                <td>
                                    <span th:if="${user.userStatus.name() == 'ACTIVE'}" class="badge bg-success" th:text="${user.userStatus.displayName}">Active</span>
                                    <span th:if="${user.userStatus.name() == 'BLOCKED'}" class="badge bg-danger" th:text="${user.userStatus.displayName}">Blocked</span>
                                    <span th:if="${user.userStatus.name() == 'PENDING'}" class="badge bg-warning" th:text="${user.userStatus.displayName}">Pending</span>
                                    <span th:if="${user.userStatus.name() == 'INACTIVE'}" class="badge bg-secondary" th:text="${user.userStatus.displayName}">Inactive</span>
                                </td>
                                <td th:text="${user.lastLogin != null ? #temporals.format(user.lastLogin, 'MMM dd, yyyy HH:mm') : 'Never'}">Never</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                th:onclick="'viewUser(' + ${user.id} + ')'">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" 
                                                th:onclick="'editUser(' + ${user.id} + ')'">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                    data-bs-toggle="dropdown">
                                                <i class="bi bi-gear"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li th:if="${user.userStatus.name() == 'ACTIVE'}">
                                                    <a class="dropdown-item" href="#" th:onclick="'blockUser(' + ${user.id} + ')'">
                                                        <i class="bi bi-lock"></i> Block User
                                                    </a>
                                                </li>
                                                <li th:if="${user.userStatus.name() == 'BLOCKED'}">
                                                    <a class="dropdown-item" href="#" th:onclick="'unblockUser(' + ${user.id} + ')'">
                                                        <i class="bi bi-unlock"></i> Unblock User
                                                    </a>
                                                </li>
                                                <li><a class="dropdown-item" href="#" th:onclick="'resetPassword(' + ${user.id} + ')'">
                                                    <i class="bi bi-key"></i> Reset Password
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" th:onclick="'deleteUser(' + ${user.id} + ')'">
                                                    <i class="bi bi-trash"></i> Delete User
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <nav th:if="${users.totalPages > 1}">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${!users.hasPrevious()} ? 'disabled'">
                    <a class="page-link" th:href="@{/admin/users(page=${users.number - 1})}">Previous</a>
                </li>
                <li class="page-item" th:each="i : ${#numbers.sequence(0, users.totalPages - 1)}" 
                    th:classappend="${i == users.number} ? 'active'">
                    <a class="page-link" th:href="@{/admin/users(page=${i})}" th:text="${i + 1}">1</a>
                </li>
                <li class="page-item" th:classappend="${!users.hasNext()} ? 'disabled'">
                    <a class="page-link" th:href="@{/admin/users(page=${users.number + 1})}">Next</a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="createUserForm" th:action="@{/admin/users}" method="post">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username *</label>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="firstName" class="form-label">First Name *</label>
                                    <input type="text" class="form-control" id="firstName" name="firstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lastName" class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" id="lastName" name="lastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phoneNumber" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userRole" class="form-label">Role *</label>
                                    <select class="form-select" id="userRole" name="userRole" required>
                                        <option value="">Select Role</option>
                                        <option th:each="role : ${T(org.example.administrator.enums.UserRole).values()}" 
                                                th:value="${role}" th:text="${role.displayName}"></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password *</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <input type="hidden" name="createdBy" value="admin">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div th:fragment="scripts">
        <script>
            // View user details
            function viewUser(userId) {
                // Implement view user functionality
                console.log('View user:', userId);
            }

            // Edit user
            function editUser(userId) {
                // Implement edit user functionality
                console.log('Edit user:', userId);
            }

            // Block user
            function blockUser(userId) {
                if (confirm('Are you sure you want to block this user?')) {
                    fetch(`/api/admin/users/${userId}/block?blockedBy=admin`, {
                        method: 'POST'
                    }).then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('Error blocking user');
                        }
                    });
                }
            }

            // Unblock user
            function unblockUser(userId) {
                if (confirm('Are you sure you want to unblock this user?')) {
                    fetch(`/api/admin/users/${userId}/unblock?unblockedBy=admin`, {
                        method: 'POST'
                    }).then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('Error unblocking user');
                        }
                    });
                }
            }

            // Reset password
            function resetPassword(userId) {
                const newPassword = prompt('Enter new password:');
                if (newPassword) {
                    fetch(`/api/admin/users/${userId}/reset-password?newPassword=${newPassword}&resetBy=admin`, {
                        method: 'POST'
                    }).then(response => {
                        if (response.ok) {
                            alert('Password reset successfully');
                        } else {
                            alert('Error resetting password');
                        }
                    });
                }
            }

            // Delete user
            function deleteUser(userId) {
                if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                    fetch(`/api/admin/users/${userId}?deletedBy=admin`, {
                        method: 'DELETE'
                    }).then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('Error deleting user');
                        }
                    });
                }
            }
        </script>
    </div>
</body>
</html>

